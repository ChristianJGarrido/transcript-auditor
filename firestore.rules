service cloud.firestore {
  match /databases/{database}/documents {

		function isAdmin() {
    	return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.admin;
    }
    
		function canAccess(accountId) {
    	return accountId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accounts;
    }    

		match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

		match /accounts/{accountId} {
    	allow read, write: if canAccess(accountId) || isAdmin();
      match /{allChildren=**} {
      	allow read, write: if canAccess(accountId) || isAdmin();
      }
    }

  }
}